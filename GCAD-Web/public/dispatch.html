<container id="unitsCont">
    <h1>UNITS:</h1>
    <ul id="units">
    </ul><hr>
</container>
<container id="callsCont">
    <h1>Calls:</h1> <button onclick="newCall()">+</button>
        <ul id="calls">  
        </ul>
    </container>
   
</container>
<button onclick="latest911void()">Open latest 911</button>
<hr>
<container id="databases">
    <container id="personDatabase" class="databaseContainers">
        <h1>Person Database</h1>
        <form id="personForm" onsubmit="PersonCheck(event)">
            <input type="text" id="databaseFirstname" placeholder="Firstname"><br>
            <input type="text" id="databaseSurname" placeholder="Surname">
            <button>Send!</button>
        </form>
    </container>
    <container id="VehicleDatabase" class="databaseContainers">
        <h1>Vehicle Database</h1>
        <form>
            <input type="text" placeholder="License plate number">
        </form>
    </container>
</container>
<container id="alert911" hidden>
    <img src="media/close.png" id="close" onclick="document.getElementById('alert911').hidden = true">
    <h2>NEW 911!</h2>
    <button onclick="view911()">Go to 911</button>
</container>
<container id="info911cont" hidden>
    <img src="media/close.png" id="close" onclick="document.getElementById('info911cont').hidden = true">
    <h2>911</h2>
    <p id="info911">Somthing went wrong, could not get 911 info</p>
</container>
<container id="newCall" hidden>
    <p>Create New Call!</p>
    <form id="newCallForm">
        <img id="close" src="media/close.png" onclick="document.getElementById('newCall').hidden = true; document.getElementById('newCallForm').reset()">
        <input id="code10" placeholder="10-code" required><br>
        <input id="newCallDes" placeholder="description" required><br>
        <input placeholder="location" required><br>
        <select id="unitsNewCall" required>
        </select><br><br>
        <button type="submit">ok!</button>
    </form>
</container>
<container id="databaseInfo" >
    <img id="close" src="media/close.png" onclick="windowHandle('databaseInfo', true)">
    <h2>Database Return:</h2>
    <p>Firstname: <container id="firstnameInfo">undefined</container></p>
    <p>Surname: <container id="surnameInfo">undefined</container></p>
    <p>BirthDate: <container id="birthDateInfo">undefined</container></p>
    <p>Build type: <container id="buildTypeInfo">undefined</container></p>
    <p>License Status: <container id="licensesInfo">none</container></p>
    <h4>Change License Status:</h4>
    <select id="changeLicenseSelect" onchange="changeLicense(false)">
        <option id="valid">Valid</option>
        <option id="suspended">Suspended</option>
        <option id="recalled">Recalled (To Be suspended when found)</option>
    </select><br><br>
    <container id="warrants">
        <button id="addWarrantButton" onclick="windowHandle('databaseInfo', true); windowHandle('newWarrant', false)">+</button>
        <button id="removeAllWarrants" onclick="removeAllWarrants()">remove all</button> 
        <p>Warrants:</p>
            <ul id="warrantsUL"></ul>
    </container>
    <container id="guns">
        <p>Registered Guns:</p>
        <ul id="gunsUL"></ul>
    </container>
</container>
<div id="ErrorNoCon" hidden>
    <h1>Error!</h1>
    <p>Could not establish connection with the server</p>
    <p>Please try again later</p>
</div>
<script src="/socket.io/socket.io.js"></script>
<script
  src="https://code.jquery.com/jquery-3.4.1.js"
  integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
  crossorigin="anonymous"></script>
<script>
    var socket = io();
    var fromUnitLoggedIn = false;
    var maxId;
    var latest911
    $(function(){
        if(getCookie("username") && getCookie("key") && getCookie("dep")){
            socket.emit("check", getCookie("username"), getCookie("key"), true)
        }
        else{
            window.location.href="dep.html"
        }
    })
    $("#newCallForm").submit((e) => {
        e.preventDefault()
        socket.emit("ammountCalls")

    })
    socket.on("panic", () => {
        var audio = new Audio("media/panic.mp3")
        audio.play()
    })
    socket.on("notAllowed", () => {
        window.location.href="index.html"
    })
    socket.on("deps", (array) => {
        var found = false
        for(var i = 0; i<array.length; i++){
            if(array[i] == "communications"){
                found = true
            }
        }
        if(!found){
            alert("you do not have access to this department!")
            window.location.href="dep.html"
        }
        socket.emit("requestCalls")
    })
    socket.on("unitLoggedIn", (units) => {
        $("#units").empty();
        $("#unitsNewCall").empty()
        for(var i = 0; i<units.length; i++){
            var callsignString = "onchange=callsign('"+units[i].callsign+"')"
            $("#units").append('<container id="'+units[i].callsign+'"><li id="unitCont">'+units[i].callsign+'<container id="status"><select id="statusSelect" '+callsignString+'><option disabled selected value="'+units[i].status+'">'+units[i].status+'</option><option value="10-8">10-8</option><option value="10-7">10-7</option><option value="10-6">10-6</option></select></container><container id="logout" onclick=logoutUnit("'+units[i].callsign+'")>Log Unit Out</container></li></container>')
            $("#unitsNewCall").append("<option id="+units[i].callsign+">"+units[i].callsign+"</option>")
            for(var b = 0; b<=maxId; b++){
                var Abort = false;
                var deployedUnits = getCookie(`call${b}.units`)
                var deployedUnitsArray = deployedUnits.split(",")
                for(var c = 0; c<deployedUnitsArray.length; c++){
                    if(deployedUnitsArray[c] == units[i].callsign){
                        Abort = true;
                    }
                }
                if(Abort){
                    abort = false;
                    continue
                }
                else{
                $(`#addUnitSelect${b}`).append(`<option id="${units[i].callsign}">${units[i].callsign}</option>`)
                }
            }
        }
    })
    socket.on("calls", (ammount) => {
        var value = document.getElementById("unitsNewCall")
        var selectValue = value.options[value.selectedIndex].value
        document.getElementById("newCall").hidden = true
        socket.emit("callCreated", ammount, $("#code10").val(), $("#newCallDes").val(), selectValue)
    })
    socket.on("newCall", (call) => {
        maxId++
        var newMainUnit = call.mainUnit.join("<br>")
        var call = '<container id="call'+call.callID+'"><li id="call"><container id="full10">10-code: <container id="code">'+call.Code10+'</container></container><container id="fullDes">Description:<container id="description">'+call.description+'</container></container><container id="fullCallStat"> Status: <container id="callStatusSelect"><select id="Call'+call.callID+'status" onchange="callStatus('+call.callID+')"><option value="none">none</option><option value="code 4">code 4</option></select> </container></container><container id="fullUnit"> First unit: <container id="callUnit">'+newMainUnit+'</container></container> <img id="deleteCall" src="media/delete.png" onclick="deleteCall('+call.callID+')"><container id="addUnitCont">Add Units To Call: <select id="addUnitSelect'+call.callID+'" onchange=addUnit("'+call.callID+'")><option id="start" selected hidden>Unit</select></container></li></container>'
        socket.emit("requestCalls")
        $("#calls").append(call)
    })
    socket.on("callDeleted", (call) =>{
        var id = "call"+call
        document.getElementById(id).parentNode.removeChild(document.getElementById(id))
    })
    socket.on("currentCalls", (calls) => {
        $("#addUnitCont").empty()
        $("#calls").empty()
        for(var i = 0; i<calls.length; i++){
            console.log(calls[i].mainUnit)
            var newMainUnit = calls[i].mainUnit.join("<br>")
            var temp = calls[i].mainUnit.toString()
            var temp2 = temp.split("<li>")
            var toStorage = temp2.toString().split("</li>")
            setCookie(`call${calls[i].callID}.units`, toStorage)
            var call = '<container id="call'+calls[i].callID+'"><li id="call">10-code: <container id="code">'+calls[i].Code10+'</container><container id="fullDes"> Description: <container id="description">'+calls[i].description+'</container></container><container id="fullCallStat"> Status: <container id="callStatusSelect"><select id="Call'+calls[i].callID+'status" onchange="callStatus('+calls[i].callID+')"><option disabled selected value="'+calls[i].status+'">'+calls[i].status+'</option><option value="none">none</option><option value="code 4">code 4</option></select> </container></container><container id="fullUnit"> units: <ul id="callUnit">'+newMainUnit+'</ul></container><img id="deleteCall" src="media/delete.png" onclick="deleteCall('+calls[i].callID+')"><container id="addUnitCont">Add Units To Call: <select id="addUnitSelect'+calls[i].callID+'" onchange=addUnit("'+calls[i].callID+'")><option id="start" selected hidden>Unit</select></container></li></container>'
            $("#calls").append(call)      
            if(i == calls.length -1){
             maxId = calls[i].callID
            }
        }
        fromUnitLoggedIn = true;
        socket.emit("requestUnits")  
        console.log("currentcalls")
    })
    socket.on("callStatusChanged", (id, calls, status) => {
        for(var i = 0; i<calls.length; i++){
            if("call"+id == document.getElementById("call"+calls[i].callID).id){
                document.getElementById("call"+calls[i].callID).parentNode.removeChild(document.getElementById("call"+calls[i].callID))
                var call = '<container id="call'+calls[i].callID+'"><li id="call">10-code: <container id="code">'+calls[i].Code10+'</container><container id="fullDes"> Description:<container id="description">'+calls[i].description+'</container></container><container id="fullCallStat"> Status: <container id="callStatusSelect"><select id="Call'+calls[i].callID+'status" onchange="callStatus('+calls[i].callID+')"><option value="'+status+'" disabled selected>'+status+'</option><option value="none">none</option><option value="code 4">code 4</option></select> </container></container><container id="fullUnit">units: <ul id="callUnit">'+calls[i].mainUnit+'</ul></container> <img id="deleteCall" src="media/delete.png" onclick="deleteCall('+calls[i].callID+')"><container id="addUnitCont">Add Units To Call: <select id="addUnitSelect" onchange=addUnit("'+calls[i].callID+'")><option id="start" selected hidden>Unit</select></container></li></container>'
                socket.emit("requestUnits")
                $("#calls").append(call)
            }
        }
    })
    socket.on("warn911", (msg) => {
        var audio = new Audio("media/alarm.mp3")
        audio.play()
        document.getElementById("alert911").hidden = false
        latest911 = msg
    })
    socket.on("civInfo", (civ) => {
        socket.emit("check", getCookie("username"), getCookie("key"), true)
        $("#warrantsUL").empty()
        $("#gunsUL").empty()
        if(civ == false){
            alert("No results")
        }
        else{
            windowHandle("databaseInfo", false)
            document.getElementById("firstnameInfo").innerHTML = civ.Firstname
            document.getElementById("surnameInfo").innerHTML = civ.Surname
            document.getElementById("birthDateInfo").innerHTML = civ.BirthDate
            document.getElementById("buildTypeInfo").innerHTML = civ.Build
            if(civ.license != ""){
                document.getElementById("licensesInfo").innerHTML = civ.license
                $("#changeLicenseSelect").append("<option selected hidden disabled value="+civ.license+">"+civ.license+"</option>")
            }
            else{
                document.getElementById("licensesInfo").innerHTML = "none"
                $("#changeLicenseSelect").append("<option selected hidden disabled value=none>none</option>")

            }
            if(civ.warrants == ""){

                $("#warrantsUL").append("<li style='color:green;'>none</li>")
            }
            else{
                for(var i = 0; i<civ.warrants.length; i++){
                    $("#warrantsUL").append("<li style='color:red;'>Title: "+civ.warrants[i].title+" <br>Description: "+civ.warrants[i].description+"</li><br>")
                }
            }
            if(civ.guns == ""){
                $("#gunsUL").append("<li style='color:green;'>none</li>")
            }
            else{
                civ.guns.forEach(gun => {
                    $("#gunsUL").append(`<li style='color:orange;'>${gun.gunName} ID: ${gun.gunID}</li>`)
                })
            }
        }
    })
    function callsign(callsign){
        var value = document.getElementById("statusSelect")
        var selectValue = value.options[value.selectedIndex].value
        socket.emit("statusUpdate", selectValue, callsign)
    }
    function newCall(){
        socket.emit("requestUnits")
        document.getElementById("newCall").hidden = false
    }
    function deleteCall(ammount){
        socket.emit("deleteCall", ammount)
    }
    function callStatus(call){
        var value = document.getElementById("Call"+call+"status")
        var selectValue = value.options[value.selectedIndex].value
        socket.emit("callStatus", call, selectValue)
    }
    function logoutUnit(unit){
        socket.emit("logoutUnit", unit)
    }
    function addUnit(callID){
        var value = document.getElementById(`addUnitSelect${callID}`)
        var selectValue = value.options[value.selectedIndex].id;
        socket.emit("unitAdded", selectValue, callID)
    }
    function view911(){
        document.getElementById("alert911").hidden = true
        document.getElementById("info911").innerHTML = latest911
        document.getElementById("info911cont").hidden = false
    }
    function latest911void(){
        if(!latest911){
            alert("no 911 found")
        }
        else{
            view911()
        }
    }
    function PersonCheck(form){
        form.preventDefault()
        socket.emit("databaseSearch", $("#databaseFirstname").val(), $("#databaseSurname").val())
    }
    function windowHandle(window, action){
       document.getElementById(window).hidden = action
    }
</script>
<style>
    html{
        font-family: Verdana, Geneva, sans-serif;
    }
    #units{
        list-style-type: none;
    }
    #status{
        position: absolute;
        left:40%;
    }
    #logout{
        position: absolute;
        left:85%;
        cursor: pointer;
    }
    #calls{
        list-style-type: none;
    }
    #call{
        background-color:red;
        padding:1%;
        border-color:black;
        border-style:solid;
        border-width:1%;
    }
    #newCall{
        text-align: center;
        position: absolute;
        left:40%;
        top:35%;
        background-color:grey;
        padding:4%;
        border-color:black;
        border-style:solid;
        border-width:10px;
        border-radius:10%;
    }
    #close{
        position: absolute;
        width:5%;
        bottom:90%;
        right:90%;
        cursor: pointer;

    }
    #code{
        color:white;
    }
    #description{
        color:white;
    }
    #callUnit{
        color:white;
        list-style:none;
    }

    #deleteCall{
        width:1%;
        cursor: pointer;
        background:white;
        position: absolute;
        left:95%;
    }
    #unitCont{
        color:white;
        padding:1%;
        border-color: black;
        border-style: solid;
        border-width: 1%;
        background-color:green;
    }
    #fullDes{
        position: absolute;
        left:20%;
    }
    #fullCallStat{
        position: absolute;
        left:40%;
    }
    #fullUnit{
        position: absolute;
        left:55%;
        overflow: scroll;
        overflow-x:auto;
        height: 4%;
    }
    #addUnitCont{
        position: relative;
        left:67%;
    }
    #alert911{
        color: red;
        position: absolute;
    left:35%;
    padding:10%;
    border-color: black;
    border-style:solid;
    border-width:10px;
    border-radius:10%;
    bottom:35%;
    text-align: center;
    font-weight: 900;
    font-size: 200%;
    background-color: grey;    
    }
    #alert911 h2{
        position: absolute;
        right: 18%;
        top:5%;
    }
    #info911cont{
        color: white;
        position: absolute;
    left:35%;
    min-width: 40%;
    max-width:40%;
    min-height: 50%;
    max-height: 50%;
    border-color: black;
    border-style:solid;
    border-width:10px;
    border-radius:10%;
    bottom:35%;
    text-align: center;
    font-weight: 900;
    font-size: 200%;
    background-color: grey;  
    max-width: 50%;
    overflow-y: scroll;
    overflow-x: hidden;
    }
    #databases{
        padding: 0;
        position: relative;
        display: block;
        position: relative;
        margin-top:200px;
        left:50%;
        margin-left:-500px;
        width:1000px ;
    }
    #personDatabase{
        float:left;
    }
    #VehicleDatabase{
        float:left;
    }
    #databaseInfo{
    background-color: white;
    position: absolute;
    left:35%;
    padding:7%;
    border-color: rgb(59, 119, 188);;
    border-style:solid;
    border-width:10px;
    border-radius:0%;
    bottom:10%;
    text-align: center;
}
#ErrorNoCon{
        position: absolute;
        background-color: red;
        width: 500px;
        height: 150px;
        border-width: 5px;
        border:solid;
        border-color: yellow;
        left:50%;
        top:50%;
        margin-left:-250px;
        margin-top:-75px;

    }
    #ErrorNoCon h1{
        position: relative;
        left: 50%;
        width: 80px;
        margin-left:-40px;
    }
    #ErrorNoCon p{
        text-align: center;
    }
    
    ::-webkit-scrollbar{
        display:none;
    }
    .databaseContainers{
        float:left;
        width: 200px;
        margin-left:200px;
    }
    body{
        -ms-overflow-style: none;
    }
</style>
<script src="/script/public.js"></script>